name: release-canary

on:
  pull_request:
    types:
      - labeled
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to build and release'
        required: true
        default: 'main'
      release_name:
        description: 'Release name to publish to npm'
        required: true
        default: 'experimental'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Validate label name
        if: ${{ github.event_name == 'pull_request' && github.event.label.name == 'build' }}
        run: echo "Label is 'build', proceeding with the workflow."

      - name: Check for open pull request
        if: ${{ github.event_name == 'workflow_dispatch' }}
        id: check_pr
        run: |
          PR_DATA=$(gh pr list --state open --head ${{ inputs.branch }} --json number --jq '.[0]')
          if [ -z "$PR_DATA" ]; then
            echo "No open pull request found for branch ${{ inputs.branch }}."
            exit 1
          fi
          echo "PR_NUMBER=$(echo $PR_DATA | jq -r '.number')" >> $GITHUB_ENV

      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.branch || github.event.pull_request.head.sha }}
      # Setup .npmrc file to publish to npm
      - uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          registry-url: 'https://registry.npmjs.org'
      # Ensure that the README is published with the package
      - run: rm -f packages/cli/README.md && cp README.md packages/cli
      - name: Set PR_VERSION
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "PR_VERSION=${{ inputs.release_name }}" >> $GITHUB_ENV
          else
            pr_number=${{ github.event.pull_request.number }}
            git_hash=$(git rev-parse --short HEAD)
            echo "PR_VERSION=0.0.0-pr.${pr_number}${git_hash}" >> $GITHUB_ENV
          fi
      - run: npm ci
      - run: npm version ${{ env.PR_VERSION }} --workspace packages/cli
      - run: npm publish --workspace packages/cli --tag experimental
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      - uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: PR Preview Release Published
          hide_and_recreate: true
          hide_classify: "OUTDATED"
          message: |
            ðŸŽ‰ Experimental release successfully published [on npm](https://npmjs.com/package/checkly/v/${{env.PR_VERSION}})
            ```
            npm install checkly@${{env.PR_VERSION}}
            ```
 
